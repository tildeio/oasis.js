output "dist"

class BrowserIIFE < Rake::Pipeline::Filter
  def generate_output(inputs, output)
    inputs.each do |file|
      output.write %{(function(exports) {\n#{file.read}\nexports.Oasis = requireModule('oasis');\n})(this);}
    end
  end
end

require "js_module_transpiler"
require "pry"

class ModuleTranspiler < Rake::Pipeline::Filter
  def initialize(options, &block)
    @type = options[:type]
    @name = options[:name]
    @into = options[:into]
    super(&block)
  end

  def generate_output(inputs, output)
    inputs.each do |input|
      converter = JsModuleTranspiler::Compiler.new(input.read, @name, into: @into)
      output.write converter.send("to_#{@type}")
    end
  end
end

input "lib" do
  match "oasis.js" do
    filter ModuleTranspiler, name: "oasis", type: :amd
    concat { ["oasis.amd.js", "oasis.js" ] }
  end

  match "{loader,uuid.core,kamino,message_channel,rsvp.amd,oasis}.js" do
    concat ["loader.js", "uuid.core", "kamino", "message_channel", "rsvp.amd.js", "oasis.js"], "oasis.js"
    filter BrowserIIFE
  end
end

input "test" do
  output "tmp/tests"
  concat
end

# vim: filetype=ruby
