<!DOCTYPE html>
<html>
<head>
  <script src="/oasis.js" ></script>
  <script src="/fixtures/shims.js"></script>
  <script src="/vendor/jquery.js"></script>
  <script type="text/javascript">
    /*global _addEventListener */

    new Oasis.RSVP.Promise(function (resolve, reject) {
      var n = 0;

      function waitForAsyncScript() {
        if (typeof _addEventListener === 'function') {
          resolve();
        } else if (++n < 10) {
          setTimeout(waitForAsyncScript, 100);
        } else {
          reject('_addEventListener not found');
        }
      }
      waitForAsyncScript();
    }).then(function () {
      oasis.connect('assertions', function(port) {
        var assertions = port,
            iframe = document.createElement('iframe'),
            origin = location.protocol + "//" + location.hostname + ":" + (parseInt(location.port, 10) + 2);

        iframe.src = origin + "/fixtures/same_origin.html";

        _addEventListener(window, "message", function (event) {
          if( event.data === "childInitialized" ) {
            assertions.send('result', 'success');
          }
        });

        // We need to wait for document.body to be available
        // In some cases (only encountered with Saucelabs),
        // `document.body` can be null
        // See http://stackoverflow.com/questions/9916747/why-is-document-body-null-in-my-javascript
        $(document).ready( function() {
          document.body.appendChild(iframe);
        });
      });
    }, Oasis.RSVP.rethrow);
  </script>
</head>
<body>
</body>
</html>
